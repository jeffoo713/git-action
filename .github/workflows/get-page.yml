name: Get confluence page by label

on:
  push:
    branches: [ master ]

jobs:
  get-confluence-page:
    runs-on: ubuntu-latest
    steps:
      - name: Get Page by Label
        id: confPage
        uses: fjogeleit/http-request-action@v1
        with:
            url: 'https://risepeople.atlassian.net/wiki/rest/api/search?expand=metadata.labels&cql=label="hack-day-test"'
            method: 'GET'
            username: ${{ secrets.CONFLUENCE_SAM_USER }}
            password: ${{ secrets.CONFLUENCE_SAM_TOKEN }}
      - name: Extract pairs
        run: |
          PAIRS=$(echo -n '${{ steps.confPage.outputs.response }}' | jq -r '.results[] | "\(.content.id) \(.url | split("/") | .[2])"')
          echo "Pairs: $PAIRS"
          echo "$PAIRS" | while read -r pair; do
            read PAGE_ID SPACE_ID <<< $pair
            echo "PAGE_ID: $PAGE_ID, SPACE_ID: $SPACE_ID"

            curl --request POST \
              --url 'https://risepeople.atlassian.net/wiki/api/v2/pages' \
              --user '${{ secrets.CONFLUENCE_SAM_USER }}:${{ secrets.CONFLUENCE_SAM_TOKEN }}' \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --data '{
              "spaceId": SPACE_ID,
              "status": "current",
              "title": "PAGE FROM CODE CHANGE",
              "parentId": $PAGE_ID,
              "body": {
                "representation": "storage",
                "value": "child page is created from github action under parent ID: $page_id"
              }
            }'

          done
